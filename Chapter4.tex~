\newpage
%----------------------------------------------------------------------------------------------------
\section{``Pair'' Programming} 
%----------------------------------------------------------------------------------------------------
\vspace{10cm}
\hrule

\lhQ Now that we have suitable tools to compare cards, what should we do ?
\lhA Compare hands.
\lhN How do we form a \il!Hand! ?
\lhA We'll write a function:
\begin{lstlisting}[frame=single]
type Hand = [Card]
hand :: String -> Hand
\end{lstlisting}
\lhN Good. But we should write a test before writing code.
\lhA Go on.
\lhN What is the simplest hand comparison we could write a test for ?
\lhA Let's try comparing simple ``High Cards'' hands.
\lhN Ok. Here is a new test:
\begin{lstlisting}[frame=single,escapechar=!]
main = runTestTT $ TestList 
       [sortBy (comparing card) ud  ~?= sd
       ,map suit (cards "A♣ A♦ A♥ A♠") ~?= ['♣','♦','♥','♠']
       ,flush (cards "A♣ T♣ 3♣ 4♣ 2♣") ~?= True
       ,flush (cards "A♠ T♣ 3♣ 4♣ 2♣") ~?= False
       ,flush (cards "A♠ T♠ 3♠ 4♠ 2♠") ~?= True
       ,comparing hand "6♣ 4♦ A♣ 3♠ K♠" "8♠ J♥ 7♦ 5♥ 6♣" ~?= GT]
    where cards = map card . words 
\end{lstlisting} % $
\hspace*{\fill}
\lhA This last test is a bit long.
\lhN Ok, let's rephrase it this way:
\begin{lstlisting}[frame=single]
main = runTestTT $ TestList 
       [sortBy (comparing card) ud  ~?= sd
       ,map suit (cards "A♣ A♦ A♥ A♠") ~?= ['♣','♦','♥','♠']
       ,flush (cards "A♣ T♣ 3♣ 4♣ 2♣") ~?= True
       ,flush (cards "A♠ T♣ 3♣ 4♣ 2♣") ~?= False
       ,flush (cards "A♠ T♠ 3♠ 4♠ 2♠") ~?= True
       ,"6♣ 4♦ A♣ 3♠ K♠" `beat` "8♥ J♥ 7♦ 5♥ 6♣"]
    where cards = map card . words 
          beat h g = comparing hand h g ~?= GT
\end{lstlisting} % $
\hspace*{\fill}
\lhA \error OK. We need to create the \il!hand! function. But first I will borrow your \il!cards! utility function.
\lhN Sure, take it to your side.
\begin{lstlisting}[frame=single]
main = runTestTT $ TestList 
       [sortBy (comparing card) ud  ~?= sd
       ,map suit (cards "A♣ A♦ A♥ A♠") ~?= ['♣','♦','♥','♠']
       ,flush (cards "A♣ T♣ 3♣ 4♣ 2♣") ~?= True
       ,flush (cards "A♠ T♣ 3♣ 4♣ 2♣") ~?= False
       ,flush (cards "A♠ T♠ 3♠ 4♠ 2♠") ~?= True
       ,"6♣ 4♦ A♣ 3♠ K♠" `beat` "8♥ J♥ 7♦ 5♥ 6♣"]
    where beat h g = comparing hand h g ~?= GT
\end{lstlisting} % $
\hspace*{\fill}
\lhA \error Thanks
\begin{lstlisting}[frame=single]
cards :: String -> [Cards]
cards = map card . words 
\end{lstlisting}
In fact forming a hand is just making \il!Card!s from \il!String!s and sorting them:
\begin{lstlisting}[frame=single]
hand :: String -> Hand
hand = sort . cards
\end{lstlisting}
\failure Except we get \il!LT! instead of \il!GT!.
\lhN Of course: we're sorting in the wrong order. How can we change the sorting order ?
\lhA We can use \il!sortBy! and a give it the proper comparison function. 
\lhN Given what $GHCI$ tells us about \il!sort!, \il!sortBy! and \il!compare!:
\begin{small}
\begin{verbatim}
:type sort
sort :: (Ord a) => [a] -> [a]
:type sortBy
sortBy :: (a -> a -> Ordering) -> [a] -> [a]
:type compare
compare :: (Ord a) => a -> a -> Ordering
\end{verbatim}
\end{small}
We know that \il!sortBy compare! is equivalent to \il!sort!. 
How can we reverse the result given by \il!compare! ?
\lhA By \il!flip!ping its arguments. \il!flip f a b! is equivalent to \il!f b a!. Thus:
\begin{lstlisting}[frame=single]
hand :: String -> Hand
hand = sortBy (flip compare) . cards
\end{lstlisting}
\success will do the trick.
\lhN Ok. What is the next hand that can beat a \emph{High Card} ?
\lhA A \emph{Pair}.
\lhN Then I'll write this test:
\begin{lstlisting}[frame=single]
       ,"6♣ 4♦ A♣ 3♠ K♠" `beat` "8♥ J♥ 7♦ 5♥ 6♣"
       ,"5♥ 4♦ 3♥ 2♦ 2♥" `beat` "A♥ K♥ Q♦ J♦ 9♥"]
    where beat h g = comparing hand h g ~?= GT
\end{lstlisting}
Meaning: the lowest \emph{Pair} should beat the highest \emph{High Card}.
\lhA \failure The test fails. We have to detect that the hand is a pair, and use that information to trump the usual card comparison.
\lhN How do we do that?
\lhA \failure We declare that in the \il!Hand! type, a \emph{Pair} is always greater than a \emph{High Card}. 
\lhN How do we order values within a type?
\lhA \failure We declare it as an algebraic type, saying we either have a \il!HighCard! followed by a list of \il!Card!s, or a \il!Pair!:
\begin{lstlisting}[frame=single]
data Hand = HighCard [Card]
            | Pair
            deriving (Ord,Eq)
\end{lstlisting}
\error Of course, now the implementation of \il!hand! doesn't yield a correct \il!Hand! value.
\lhN The compiler says:
\begin{small}
\begin{verbatim}
Couldn't match expected type `Hand' 
    against inferred type `[Card]'
In the expression: 
   sortBy (flip compare) . cards
In the definition of `hand': 
   hand = sortBy (flip compare) . cards
\end{verbatim}
\end{small}
Can you arrange this ?
\lhA Yes. Let's begin by forcing the function to a \il!HighCard! value:
\begin{lstlisting}[frame=single]
hand :: String -> Hand
hand = HighCard . sortBy (flip compare) . cards
\end{lstlisting}
\failure and we're back with a failing test instead of a compiler error.
\lhN Can you \emph{fake} the correct construction that would make the test pass ?
\lhA Yes. Let's just insert a special case:
\begin{lstlisting}[frame=single]
hand :: String -> Hand
hand "5♥ 4♦ 3♥ 2♦ 2♥" = Pair 
hand s = HighCard $ sortBy (flip compare) $ cards s
\end{lstlisting}
\success And the test is passing.

\lhend


